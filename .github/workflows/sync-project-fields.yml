name: Sync Issue Form → Project fields

on:
  issues:
    types: [opened, edited]

permissions:
  contents: read
  issues: write
  pull-requests: write
  projects: write

jobs:
  sync:
    runs-on: ubuntu-latest
    env:
      PROJECT_NUMBER: "11"   # nº do Project da org
      OWNER_LOGIN: "Clickpto"
      PROJECT_SCOPE: "org"   # "org" (project da organização) | "repo" (project do repositório)
      DEBUG: "true"         # mude para "true" para logs detalhados
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            const core = require('@actions/core');

            // ---- DEBUG flag (apenas via env.DEBUG) ----
            const DEBUG = (process.env.DEBUG || "").toLowerCase() === "true";
            function dlog(title, obj) {
              if (!DEBUG) return;
              try {
                core.startGroup(String(title));
                if (typeof obj === "string") core.info(obj);
                else core.info(JSON.stringify(obj, null, 2));
              } finally {
                core.endGroup();
              }
            }

            // ======= 1) Ler corpo da issue e extrair valores do form =======
            const body = context.payload.issue.body || "";
            dlog("DEBUG: Issue body (markdown)", body);

            // Captura a primeira linha depois do rótulo (tolerante a emojis/markdown)
            function pickBlock(labelPattern, cast = (x) => x) {
              const re = new RegExp(`^\\s*.*\\b${labelPattern}\\b.*\\R+([^\\n\\r]+)`, "mi");
              const m = body.match(re);
              return m ? cast(m[1].trim()) : null;
            }

            const priority  = pickBlock("Priority");
            const storyRaw  = pickBlock("Story\\s*Points");
            const iteration = pickBlock("Iteration"); // vale para "Iteration (Sprint)" também
            const startDate = pickBlock("Start\\s*date", s => (s.match(/\d{4}-\d{2}-\d{2}/)?.[0] ?? null));
            const endDate   = pickBlock("End\\s*date",   s => (s.match(/\d{4}-\d{2}-\d{2}/)?.[0] ?? null));
            const release   = pickBlock("Release");

            dlog("DEBUG: Valores extraídos", { priority, storyRaw, iteration, startDate, endDate, release });

            // ======= 2) Validações =======
            const validPriority = ["Critical", "High", "Medium", "Low"];
            if (priority && !validPriority.includes(priority)) {
              core.setFailed(`Priority inválida: "${priority}". Use: ${validPriority.join(", ")}.`);
              return;
            }

            const storyPts = storyRaw != null ? Number(String(storyRaw).match(/\d+/)?.[0]) : null;
            const validStoryPoints = [1, 3, 5, 8, 13];
            if (storyPts != null && !validStoryPoints.includes(storyPts)) {
              core.setFailed(`Story Points inválido: ${storyPts}. Use apenas 1, 3, 5, 8 ou 13.`);
              return;
            }

            if (startDate && !/^\d{4}-\d{2}-\d{2}$/.test(startDate)) {
              core.setFailed(`Start date inválida: "${startDate}". Use formato YYYY-MM-DD.`);
              return;
            }
            if (endDate && !/^\d{4}-\d{2}-\d{2}$/.test(endDate)) {
              core.setFailed(`End date inválida: "${endDate}". Use formato YYYY-MM-DD.`);
              return;
            }
            if (startDate && endDate && new Date(startDate) > new Date(endDate)) {
              core.setFailed(`Start date (${startDate}) não pode ser maior que End date (${endDate}).`);
              return;
            }

            // ======= 3) Obter Project + fields (GraphQL) =======
            const projectNumber = parseInt(process.env.PROJECT_NUMBER, 10);
            const owner = process.env.OWNER_LOGIN;

            let projectQuery, projectVars;
            if (process.env.PROJECT_SCOPE === "org") {
              projectQuery = `
                query($owner: String!, $number: Int!) {
                  organization(login: $owner) {
                    projectV2(number: $number) {
                      id
                      fields(first: 50) {
                        nodes {
                          ... on ProjectV2FieldCommon { id name dataType }
                          ... on ProjectV2SingleSelectField { id name options { id name } }
                          ... on ProjectV2IterationField { id name configuration { iterations { id title } } }
                        }
                      }
                    }
                  }
                }`;
              projectVars = { owner, number: projectNumber };
            } else {
              projectQuery = `
                query($owner: String!, $repo: String!, $number: Int!) {
                  repository(owner: $owner, name: $repo) {
                    projectV2(number: $number) {
                      id
                      fields(first: 50) {
                        nodes {
                          ... on ProjectV2FieldCommon { id name dataType }
                          ... on ProjectV2SingleSelectField { id name options { id name } }
                          ... on ProjectV2IterationField { id name configuration { iterations { id title } } }
                        }
                      }
                    }
                  }
                }`;
              projectVars = { owner, repo: context.repo.repo, number: projectNumber };
            }

            const projRes = await github.graphql(projectQuery, projectVars);
            const project = process.env.PROJECT_SCOPE === "org"
              ? projRes.organization.projectV2
              : projRes.repository.projectV2;
            if (!project) throw new Error("Project não encontrado. Verifique OWNER_LOGIN / PROJECT_NUMBER / PROJECT_SCOPE.");

            const fields = project.fields.nodes || [];
            dlog("DEBUG: Campos do Project (name/dataType)", fields.map(f => ({ name: f.name, dataType: f.dataType || "custom" })));

            const byName = (n) => fields.find(f => f.name?.toLowerCase() === n.toLowerCase());

            // Mapear fields do Project (sem Status)
            const fPriority  = byName("Priority");
            const fStory     = byName("Story Points");
            const fIteration = byName("Iteration");
            const fStart     = byName("Start date");
            const fEnd       = byName("End date");
            const fRelease   = byName("Release");

            dlog("DEBUG: IDs dos fields", {
              Priority: fPriority?.id, StoryPoints: fStory?.id, Iteration: fIteration?.id,
              StartDate: fStart?.id, EndDate: fEnd?.id, Release: fRelease?.id
            });

            // ======= 4) Garantir item no Project e obter itemId =======
            const contentId = context.payload.issue.node_id;
            let itemId = null;

            try {
              const addRes = await github.graphql(`
                mutation($projectId: ID!, $contentId: ID!) {
                  addProjectV2ItemById(input: {projectId: $projectId, contentId: $contentId}) {
                    item { id }
                  }
                }`,
                { projectId: project.id, contentId }
              );
              itemId = addRes?.addProjectV2ItemById?.item?.id || null;
              dlog("DEBUG: Resultado addProjectV2ItemById", addRes);
            } catch (e) {
              dlog("DEBUG: addProjectV2ItemById falhou (provável item já existente)", String(e));
            }

            if (!itemId) {
              const findItemRes = await github.graphql(`
                query($contentId: ID!) {
                  node(id: $contentId) {
                    ... on Issue {
                      projectV2Items(first: 50) { nodes { id project { id title number } } }
                    }
                    ... on PullRequest {
                      projectV2Items(first: 50) { nodes { id project { id title number } } }
                    }
                  }
                }`,
                { contentId }
              );
              const items = findItemRes?.node?.projectV2Items?.nodes || [];
              itemId = items.find(n => n.project?.id === project.id)?.id || null;
              dlog("DEBUG: projectV2Items da Issue", items);
            }
            if (!itemId) throw new Error("Não foi possível obter o itemId do Project para esta issue.");
            dlog("DEBUG: itemId alvo", { itemId });

            // ======= 5) Helpers de atualização =======
            async function setSingleSelect(field, label) {
              if (!field || !label) return;
              const wanted = String(label).trim().toLowerCase();
              const opt = field.options.find(o => o.name?.trim().toLowerCase() === wanted);
              if (!opt) {
                core.setFailed(`Opção "${label}" não encontrada no campo "${field.name}".`);
                return;
              }
              dlog(`DEBUG: setSingleSelect ${field.name}`, { label, optionId: opt.id });
              await github.graphql(`
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $opt: ID!) {
                  updateProjectV2ItemFieldValue(input:{
                    projectId: $projectId,
                    itemId: $itemId,
                    fieldId: $fieldId,
                    value: { singleSelectOptionId: $opt }
                  }) { projectV2Item { id } }
                }`,
                { projectId: project.id, itemId, fieldId: field.id, opt: opt.id }
              );
            }

            async function setNumber(field, value) {
              if (!field || value == null || value === "") return;
              const num = Number(value);
              if (Number.isNaN(num)) return;
              dlog(`DEBUG: setNumber ${field.name}`, { value: num });
              await github.graphql(`
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $num: Float!) {
                  updateProjectV2ItemFieldValue(input:{
                    projectId: $projectId,
                    itemId: $itemId,
                    fieldId: $fieldId,
                    value: { number: $num }
                  }) { projectV2Item { id } }
                }`,
                { projectId: project.id, itemId, fieldId: field.id, num }
              );
            }

            async function setDate(field, dateStr) {
              if (!field || !dateStr) return;
              dlog(`DEBUG: setDate ${field.name}`, { date: dateStr });
              await github.graphql(`
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $date: Date!) {
                  updateProjectV2ItemFieldValue(input:{
                    projectId: $projectId,
                    itemId: $itemId,
                    fieldId: $fieldId,
                    value: { date: $date }
                  }) { projectV2Item { id } }
                }`,
                { projectId: project.id, itemId, fieldId: field.id, date: dateStr }
              );
            }

            async function setText(field, text) {
              if (!field || !text) return;
              dlog(`DEBUG: setText ${field.name}`, { text });
              await github.graphql(`
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $text: String!) {
                  updateProjectV2ItemFieldValue(input:{
                    projectId: $projectId,
                    itemId: $itemId,
                    fieldId: $fieldId,
                    value: { text: $text }
                  }) { projectV2Item { id } }
                }`,
                { projectId: project.id, itemId, fieldId: field.id, text }
              );
            }

            async function setIteration(field, iterTitle) {
              if (!field || !iterTitle) return;
              const wanted = String(iterTitle).trim().toLowerCase();
              const it = field.configuration.iterations.find(i => i.title?.trim().toLowerCase() === wanted);
              if (!it) {
                core.setFailed(`Iteração "${iterTitle}" não encontrada no campo "${field.name}". Verifique o título no Project.`);
                return;
              }
              dlog(`DEBUG: setIteration ${field.name}`, { iterTitle, iterationId: it.id });
              await github.graphql(`
                mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $iter: ID!) {
                  updateProjectV2ItemFieldValue(input:{
                    projectId: $projectId,
                    itemId: $itemId,
                    fieldId: $fieldId,
                    value: { iterationId: $iter }
                  }) { projectV2Item { id } }
                }`,
                { projectId: project.id, itemId, fieldId: field.id, iter: it.id }
              );
            }

            // ======= 6) Aplicar updates =======
            await setSingleSelect(fPriority, priority);
            await setNumber      (fStory,    storyPts);
            await setIteration   (fIteration, iteration);
            await setDate        (fStart,    startDate);
            await setDate        (fEnd,      endDate);
            await setText        (fRelease,  release);

            core.info("✅ Sincronização concluída com sucesso!");
            return "OK";
